"""
traj_dir /run_batch_exit_statuses.yaml example:
instances_by_exit_status:
    Uncaught BashIncorrectSyntaxError:
    - tornadoweb__tornado.d5ac65c1.func_pm_ctrl_shuffle__98hchtu9
    - tornadoweb__tornado.d5ac65c1.func_pm_ctrl_invert_if__q1xpqtwd
    - tornadoweb__tornado.d5ac65c1.func_pm_remove_cond__4jj1oz5i
    - tornadoweb__tornado.d5ac65c1.func_pm_remove_cond__rp019si9
    Uncaught CommandTimeoutError:
    - google__textfsm.c31b6007.func_basic__ue2e902o
    - lepture__mistune.bf54ef67.combine_module__lbdzzzki
    Uncaught EvaluationError:
    - pydata__patsy.a5d16484.func_pm_ctrl_invert_if__qhwms7eo
    - pydata__patsy.a5d16484.lm_rewrite__pmhlov0r
    - pydata__patsy.a5d16484.func_basic__18q7atp2
    - pydata__patsy.a5d16484.combine_file__qchym3la
    - gawel__pyquery.811cd048.func_pm_remove_assign__pm1aih51
    - tkrajina__gpxpy.09fc46b3.func_basic__k3jnoxxa
    - pydata__patsy.a5d16484.func_pm_ctrl_shuffle__706tx5ls
    - gawel__pyquery.811cd048.func_basic__cidxw3bw
    - tkrajina__gpxpy.09fc46b3.func_basic__nuogbk6k
    - gawel__pyquery.811cd048.func_pm_ctrl_shuffle__mq5vpmay
    - tkrajina__gpxpy.09fc46b3.func_basic__y19c7trq
    Uncaught Exception:
    - krotik__eliasdb.88a1da66.func_pm_ctrl_invert_if__7ukon1sf
    - python-trio__trio.cfbbe2c1.func_pm_ctrl_shuffle__s290y7ki
    - krotik__eliasdb.88a1da66.func_pm_flip_operators__n2tlq7uy
    - mahmoud__boltons.3bfcfdd0.func_pm_remove_assign__khqivdr6
    submitted:
    - andialbrecht__sqlparse.e57923b3.func_basic__qig6txv0
    - tobymao__sqlglot.036601ba.func_pm_ctrl_shuffle__vcwd894m
    - tweepy__tweepy.91a41c6e.func_basic__yektsuta
    - pdfminer__pdfminer.six.1a8bd2f7.func_basic__06convwo
    - mozilla__bleach.73871d76.func_basic__afx0ta8b
    - pyasn1__pyasn1.0f07d724.combine_module__6sq0n0uc
    - tobymao__sqlglot.036601ba.combine_module__ewmydl2q
    - sqlfluff__sqlfluff.50a1c4b6.func_basic__dk2de1z7
    - getmoto__moto.694ce1f4.func_pm_ctrl_shuffle__a0jnj7ry
    - mozilla__bleach.73871d76.combine_file__3md5e1na
    - andialbrecht__sqlparse.e57923b3.func_pm_remove_assign__gyw41euv
    - pallets__click.fde47b4b.func_basic__cf37068c
    - sqlfluff__sqlfluff.50a1c4b6.func_pm_op_change__tmbnbxj4
    - sqlfluff__sqlfluff.50a1c4b6.func_basic__0qfk2dwl
    - seperman__deepdiff.ed252022.func_pm_class_rm_base__nhutivoj
    - getmoto__moto.694ce1f4.func_pm_remove_assign__8bqvh75g
    - life4__textdistance.c3aca916.func_basic__8z2wervt
    - mozilla__bleach.73871d76.func_basic__u4qztwif
    - pallets__click.fde47b4b.func_basic__dc589ec8
    - jaraco__inflect.c079a96a.func_basic__8n3tlyhx
    - sqlfluff__sqlfluff.50a1c4b6.func_pm_remove_assign__ps0r4lid
    - pallets__click.fde47b4b.func_pm_remove_wrapper__ylnqhv2h
    - pallets__click.fde47b4b.func_basic__f9e6ba2e
    - sqlfluff__sqlfluff.50a1c4b6.func_basic__ppgcunyk
    - sqlfluff__sqlfluff.50a1c4b6.lm_rewrite__5n2sn94d
    - Knio__dominate.9082227e.combine_file__ipd1y2xj
    - pallets__click.fde47b4b.func_basic__1a2c999a
    - kennethreitz__records.5941ab27.func_basic__8ansg240
    - pyasn1__pyasn1.0f07d724.combine_file__v8sudci8
    - pyasn1__pyasn1.0f07d724.combine_module__pgwq0qtp
    - madzak__python-json-logger.5f85723f.pr_160
    - conan-io__conan.86f29e13.func_pm_class_rm_funcs__8p349qfg
    - lepture__mistune.bf54ef67.combine_file__uiiiq3ay
    - Project-MONAI__MONAI.a09c1f08.combine_file__usix0jgq
    - pyasn1__pyasn1.0f07d724.func_pm_ctrl_invert_if__20dd95z6
    - pdfminer__pdfminer.six.1a8bd2f7.func_pm_ctrl_invert_if__bbq2qsej
    - conan-io__conan.86f29e13.func_pm_remove_assign__y1ybu8ww
    - conan-io__conan.86f29e13.pr_16646
    - pytest-dev__iniconfig.16793ead.combine_file__jl9yaxwe
    - agronholm__exceptiongroup.0b4f4937.func_basic__pgf9j89u
    - tobymao__sqlglot.036601ba.func_pm_remove_cond__uwxb4q62
    - vi3k6i5__flashtext.b316c7e9.combine_file__9dxlk2rp
    - pallets__click.fde47b4b.lm_rewrite__nyegudw2
    - agronholm__exceptiongroup.0b4f4937.lm_rewrite__a4nqb1bt
    - alanjds__drf-nested-routers.6144169d.combine_file__bqgncj3s
    - tweepy__tweepy.91a41c6e.combine_file__xud7bdue
    - Project-MONAI__MONAI.a09c1f08.func_pm_op_change__il3nzuep
    - pyasn1__pyasn1.0f07d724.func_basic__986cj7db
    - madzak__python-json-logger.5f85723f.combine_file__ke8hbycn
    - python-jsonschema__jsonschema.93e0caa5.func_basic__6q2yucyk
    - sqlfluff__sqlfluff.50a1c4b6.func_pm_ctrl_shuffle__w6q2ce58
    - mozilla__bleach.73871d76.func_basic__sydz194y
    - andialbrecht__sqlparse.e57923b3.func_basic__0zb7o5ky
    - pyasn1__pyasn1.0f07d724.func_pm_ctrl_invert_if__k1gjy4nk
    - pallets__click.fde47b4b.func_basic__b6414fba
    - getmoto__moto.694ce1f4.pr_6687
    - pdfminer__pdfminer.six.1a8bd2f7.func_pm_ctrl_invert_if__faatlx02
    - pdfminer__pdfminer.six.1a8bd2f7.combine_file__dkox5kc3
    - python-hyper__h11.bed0dd4a.func_basic__k284t14p
    - alanjds__drf-nested-routers.6144169d.func_pm_ctrl_shuffle__g58niwl1
    - conan-io__conan.86f29e13.func_pm_remove_cond__5zbzo10m
    - lepture__mistune.bf54ef67.combine_module__xxs5ixan
    - pyasn1__pyasn1.0f07d724.func_basic__qrn7hc3e
    - google__textfsm.c31b6007.lm_rewrite__9ikhtnz8
    - gweis__isodate.17cb25eb.combine_file__ru8x6s7s
    - tobymao__sqlglot.036601ba.func_pm_op_change__i15nyj5e
    - gweis__isodate.17cb25eb.func_pm_remove_assign__34la72wm
    - pdfminer__pdfminer.six.1a8bd2f7.func_basic__jioygj6p
    - sqlfluff__sqlfluff.50a1c4b6.combine_file__y4de5ukc
    - sqlfluff__sqlfluff.50a1c4b6.func_pm_ctrl_invert_if__gf9peede
    - pyasn1__pyasn1.0f07d724.func_basic__4vbsduwy
    - pytest-dev__iniconfig.16793ead.combine_module__tou5haey
    - mozilla__bleach.73871d76.combine_file__2c9cnu0u
    - HIPS__autograd.ac044f0d.func_pm_ctrl_shuffle__tfgrqx46
    - pyasn1__pyasn1.0f07d724.combine_file__xnl5t179
    - tobymao__sqlglot.036601ba.func_pm_remove_loop__qy19m1bl
    - seperman__deepdiff.ed252022.func_pm_ctrl_shuffle__vzd1yc8b
    - getmoto__moto.694ce1f4.combine_module__3zswslvo
    - pyasn1__pyasn1.0f07d724.lm_rewrite__fix4ofsi
    - getmoto__moto.694ce1f4.func_pm_remove_loop__of8keuio
    submitted (exit_context):
    - vi3k6i5__flashtext.b316c7e9.func_basic__4642z3wy
    - sqlfluff__sqlfluff.50a1c4b6.func_pm_remove_loop__ljq9lg6g
    - lepture__mistune.bf54ef67.func_basic__i5xfoivq
    - lepture__mistune.bf54ef67.combine_file__yb50kyw5
    - sqlfluff__sqlfluff.50a1c4b6.func_pm_op_change__ltc1xb5y
    - conan-io__conan.86f29e13.lm_rewrite__bjytpsat
    - andialbrecht__sqlparse.e57923b3.func_pm_remove_cond__zkz31yhm
    - andialbrecht__sqlparse.e57923b3.func_pm_class_rm_funcs__mdyysnpv
    - lepture__mistune.bf54ef67.combine_file__3s2arh9x
    - davidhalter__parso.338a5760.func_pm_op_change__ko3ao0d1
    - tobymao__sqlglot.036601ba.func_pm_ctrl_invert_if__ohkt1ccy
    - conan-io__conan.86f29e13.combine_module__2pv2o3dd
    - mozilla__bleach.73871d76.lm_rewrite__gf39cr4o
"""
# We want to filter out the "submitted" 
import argparse
import json

arg_parser = argparse.ArgumentParser()
arg_parser.add_argument('--res_dir', type=str, required=True, help='Path to the predictions file')
arg_parser.add_argument('--dataset_path', type=str, required=True, help='Path to the dataset file')
arg_parser.add_argument('--output_path', type=str, required=True, help='Path to save the filtered dataset')
#load_from_disk
arg_parser.add_argument('--load_from_disk', action='store_true', help='Whether to load the dataset from disk')
args=arg_parser.parse_args()
import yaml
import os
from pathlib import Path
submitted_folders = set()
exit_statuses_path=Path(args.res_dir) / "run_batch_exit_statuses.yaml"
exit_statuses = yaml.safe_load(exit_statuses_path.read_text())
for status, inst_list in exit_statuses.get("instances_by_exit_status", {}).items():
    if status == "passed":
        submitted_folders.update(inst_list)

import datasets
# dataset = datasets.load_dataset(args.dataset_path,split='train')
if args.load_from_disk:
    dataset = datasets.load_from_disk(args.dataset_path)
else:
    dataset = datasets.load_dataset(args.dataset_path,split='train')
res_datasets = dataset.filter(lambda x: x['instance_id'] in submitted_folders)
res_datasets=res_datasets
print(f"Filtered dataset size: {len(res_datasets)}")
res_datasets.save_to_disk(args.output_path)
